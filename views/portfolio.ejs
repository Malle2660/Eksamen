<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PortfolioTracker ‚Äì Portef√∏ljeoversigt</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/portfolio-oversigt.css" />
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo-text">
          <h1>PortfolioTracker</h1>
          <p>Invest smarter</p>
        </div>
      </div>
    </aside>

    <main class="main-content">
      <header class="page-header">
        <h2>Portef√∏ljeoversigt</h2>
      </header>

      <section class="metrics">
        <div class="card">
          <div class="label">Antal portef√∏ljer</div>
          <div class="value" id="overviewCount"><%= portfolios.length %></div>
        </div>
        <div class="card">
          <div class="label">Samlet v√¶rdi</div>
          <div class="value" id="overviewTotalValue"><%= totalValue.toFixed(2) %> DKK</div>
        </div>
        <div class="card">
          <div class="label">Daglig √¶ndring</div>
          <div class="value">
            <div class="change positive" id="overviewChangePercent"><%= dailyChange.toFixed(2) %>%</div>
            <div id="overviewChangeValue"><%= dailyDKKChange.toFixed(2) %> DKK</div>
          </div>
        </div>
      </section>

      <section class="charts-tables">
        <div class="chart-container">
          <div class="chart-header">
            <h4>Fordeling af v√¶rdi i portef√∏ljer</h4>
          </div>
          <canvas id="portfolioPieChart" width="320" height="320"></canvas>
          <ul id="portfolioPieLegend" class="pie-legend"></ul>
        </div>
        <div class="table-container">
          <div class="table-header">
            <h4>Alle portef√∏ljer</h4>
            <input type="text" id="newPortfolioName" placeholder="Navn p√• portef√∏lje" style="margin-right:8px;">
            <input type="number" id="newPortfolioAccount" placeholder="Konto-ID" style="width:90px;margin-right:8px;">
            <button id="createPortfolioBtn">Opret ny</button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Navn</th>
                <th>V√¶rdi</th>
                <th>24h Change</th>
                <th>Realiseret gevinst</th>
                <th>Urealiseret gevinst</th>
                <th>Forventet v√¶rdi</th>
                <th>Oprettet</th>
              </tr>
            </thead>
            <tbody id="portfolioTableBody">
              <!-- Fyldes af JS -->
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <div id="notification" class="notification" style="display:none"></div>

  <div id="addStockForm" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:#232323; color:#fff; padding:2em; border-radius:8px; z-index:10000;">
    <h3>Tilf√∏j aktie</h3>
    <input type="text" id="stockSymbol" placeholder="Symbol (f.eks. AAPL)" style="margin-bottom:8px;display:block;">
    <input type="number" id="stockAmount" placeholder="Antal" style="margin-bottom:8px;display:block;">
    <input type="number" id="stockPrice" placeholder="K√∏bspris" style="margin-bottom:8px;display:block;">
    <button id="submitStockBtn">Tilf√∏j</button>
    <button id="cancelStockBtn" style="margin-left:8px;">Annuller</button>
  </div>

  <script>
    window.USER_ID = <%= JSON.stringify(user.id) %>;
    console.log('Portfolios:', portfolios);

    const cancelBtn = document.getElementById('cancelStockBtn');
    if (cancelBtn) {
      cancelBtn.addEventListener('click', () => {
        document.getElementById('addStockForm').style.display = 'none';
      });
    }

    const submitBtn = document.getElementById('submitStockBtn');
    if (submitBtn) {
      submitBtn.addEventListener('click', async () => {
        // ... din kode ...
      });
    }

    async function loadPortfolios() {
      try {
        const res = await fetch(`/portfolios/user`);
        const portfolios = await res.json();
        tableBody.innerHTML = '';

        if (!Array.isArray(portfolios) || portfolios.length === 0) {
          const row = document.createElement('tr');
          row.innerHTML = `<td colspan="7">Ingen portef√∏ljer endnu</td>`;
          tableBody.appendChild(row);
          updateMetrics([]);
          updatePieChart([]);
          return;
        }

        portfolios.forEach(p => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${p.name || '-'}</td>
            <td>${p.expectedValue !== undefined ? p.expectedValue.toFixed(2) + ' DKK' : '-'}</td>
            <td class="${(p.dailyChange || 0) >= 0 ? 'percent positive' : 'percent negative'}">
              ${(p.dailyChange || 0).toFixed(2)}%
            </td>
            <td>${(p.realizedGain || 0).toFixed(2)} DKK</td>
            <td>${(p.unrealizedGain || 0).toFixed(2)} DKK</td>
            <td>${(p.expectedValue || 0).toFixed(2)} DKK</td>
            <td>${p.createdAt ? new Date(p.createdAt).toLocaleDateString('da-DK') : '-'}</td>
            <td><button class="add-stock-btn" data-id="${p.portfolioID}">Tilf√∏j aktie</button></td>
          `;
          tableBody.appendChild(row);
        });

        // FLYT EVENT-LISTENERS HERIND!
        document.querySelectorAll('.add-stock-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const portfolioId = btn.getAttribute('data-id');
            showAddStockForm(portfolioId);
          });
        });

        updateMetrics(portfolios);
        updatePieChart(portfolios);
      } catch (err) {
        console.error('üö® Kunne ikke hente portef√∏ljer:', err);
        showNotification('Der opstod en fejl ved indl√¶sning af portef√∏ljer.', 'error');
      }
    }
  </script>
  <script src="/js/portfoliooversigt.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>
